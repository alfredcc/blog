<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Race Chao" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Race Chao" /> <title> 如何设计你的网络请求 - Race Chao </title> <link rel="alternate" href="http://localhost:4000/build-your-network/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/build-your-network/" /> <meta name="description" content="build your network architecture" /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="如何设计你的网络请求 | alfredcc" /> <meta property="og:title" content="如何设计你的网络请求 | alfredcc" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/build-your-network/" /> <meta property="og:description" content="build your network architecture" /> <meta property="og:image" content="http://localhost:4000/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="如何设计你的网络请求 | alfredcc" /> <meta name="twitter:url" content="http://localhost:4000/build-your-network/" /> <meta name="twitter:site" content="@alfredcc" /> <meta name="twitter:creator" content="@alfredcc" /> <meta name="twitter:description" content="build your network architecture" /> <meta name="twitter:image" content="http://localhost:4000/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Race Chao" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="dark"> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"> <a class="menu-link" href="/">Archive</a> <a class="menu-link" href="/notes/">Notes</a> <a class="menu-link" href="/about/">About</a> <a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#ios">IOS</a>, <a class="tag" href="/tags/#networking">NETWORKING</a>, <a class="tag" href="/tags/#rxswift">RXSWIFT</a> </span> </div> <h1 class="header-title" itemprop="headline">如何设计你的网络请求</h1> <div class="post-meta"> <time datetime="2020-06-28T00:34:00+08:00" itemprop="datePublished"> Jun 28, 2020 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">racechao</span> </span> <time hidden datetime="" itemprop="dateModified"> Jun 28, 2020 </time> <span hidden itemprop="publisher" itemtype="Person">racechao</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><h2 id="概述">概述</h2> <p>几乎所有的项目都需要网络请求，因为他可以给用户呈现更加丰富的内容，方便我们在不同设备之间管理同步数据。网络请求会出现在你项目的各个地方：启动页，列表页，登录注册…所以如何管理组织网络请求是 App 架构中非常重要的一部分。Github 上也有类似的框架比如 <code class="language-plaintext highlighter-rouge">Moya</code>, 我们且称其为网络框架的框架吧。<code class="language-plaintext highlighter-rouge">Moya</code> 也有这个框架也发展了很久了，功能很强大，社区也一直很活跃，也有衍生的 <code class="language-plaintext highlighter-rouge">RxMoya</code> 和 <code class="language-plaintext highlighter-rouge">ReactiveMoya</code> 。但我在使用过后发现他过于 <code class="language-plaintext highlighter-rouge">重</code> 了，一直觉得他那种 <code class="language-plaintext highlighter-rouge">path</code> + <code class="language-plaintext highlighter-rouge">method</code> + <code class="language-plaintext highlighter-rouge">parameter</code> 拆开的写法太过于繁琐，那么本文就让我们来一步步搭建适合自己的网络框架吧。</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <h2 id="概述"> <a href="#概述" class="anchor-head"></a> 概述 </h2> <p>几乎所有的项目都需要网络请求，因为他可以给用户呈现更加丰富的内容，方便我们在不同设备之间管理同步数据。网络请求会出现在你项目的各个地方：启动页，列表页，登录注册…所以如何管理组织网络请求是 App 架构中非常重要的一部分。Github 上也有类似的框架比如 <code class="language-plaintext highlighter-rouge">Moya</code>, 我们且称其为网络框架的框架吧。<code class="language-plaintext highlighter-rouge">Moya</code> 也有这个框架也发展了很久了，功能很强大，社区也一直很活跃，也有衍生的 <code class="language-plaintext highlighter-rouge">RxMoya</code> 和 <code class="language-plaintext highlighter-rouge">ReactiveMoya</code> 。但我在使用过后发现他过于 <code class="language-plaintext highlighter-rouge">重</code> 了，一直觉得他那种 <code class="language-plaintext highlighter-rouge">path</code> + <code class="language-plaintext highlighter-rouge">method</code> + <code class="language-plaintext highlighter-rouge">parameter</code> 拆开的写法太过于繁琐，那么本文就让我们来一步步搭建适合自己的网络框架吧。</p> <blockquote> <p>提示：为了方便和通用，我们的网络请求 API 就直接基于 Alamofire 来写好了。</p> </blockquote> <h2 id="方法"> <a href="#方法" class="anchor-head"></a> 方法 </h2> <p>首先我们来看看最简单的请求长什么样？</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">AF</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="s">"https://httpbin.org/get"</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>非常简单对不对？但现实并不是这样，在一个请求中我们需要处理各种疑难杂症，最终一个请求的代码可能会很长很长（长到一个屏幕都放不下！），所以我们要尽量抽象和复用这里的逻辑。</p> <p>如何下手呢？解决一个问题的最常用的方法就是先看清楚问题，然后把大问题拆成小问题，再一个个解决。我们先来思考下🤔，一个完整请求要做的事情什么：</p> <ol> <li>将 url，method，body 封装成一个 <code class="language-plaintext highlighter-rouge">HTTP Request</code> 对象，</li> <li>设置请求的 <code class="language-plaintext highlighter-rouge">HTTP Header </code></li> <li>接受 <code class="language-plaintext highlighter-rouge">HTTP Request</code> 回来的 <code class="language-plaintext highlighter-rouge">data</code> 数据</li> <li>处理 <code class="language-plaintext highlighter-rouge">error</code> 和 <code class="language-plaintext highlighter-rouge">response code</code></li> <li>通过 <code class="language-plaintext highlighter-rouge">codable</code> 之类的框架将 raw data 转换 model 对象</li> <li>请求重试</li> </ol> <p>在常规的业务中，2、3、4、5 往往是可以统一抽象处理的，而最常见做法就是用一个 <code class="language-plaintext highlighter-rouge">HTTPClient</code> 或 <code class="language-plaintext highlighter-rouge">APIManager</code> 来统一 handle 这类逻辑了。而对于 <code class="language-plaintext highlighter-rouge">1</code> 每个请求的参数、地址、方法都不一样所以我们还是会将他们暴露出去，最终大概长这样：</p> <blockquote> <p>warning：下面方法只是替提供思路，部分代码被省略</p> </blockquote> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">HTTPClient</span> <span class="p">{</span>
  
  <span class="k">var</span> <span class="nv">host</span><span class="p">:</span> <span class="kt">String</span>
  
  <span class="nf">init</span><span class="p">(</span><span class="nv">host</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
  <span class="p">}</span>
  
  <span class="c1">// 设置 timeout</span>
  <span class="kd">private</span> <span class="k">let</span> <span class="nv">sessionManager</span><span class="p">:</span> <span class="kt">SessionManager</span> <span class="o">=</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">config</span> <span class="o">=</span> <span class="kt">URLSessionConfiguration</span><span class="o">.</span><span class="k">default</span>
    <span class="n">config</span><span class="o">.</span><span class="n">timeoutIntervalForRequest</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="k">let</span> <span class="nv">sessionManager</span> <span class="o">=</span> <span class="kt">SessionManager</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sessionManager</span>
  <span class="p">}()</span>
  
  <span class="c1">// 设置 HTTPHeaders</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nv">defaultHeader</span><span class="p">:</span> <span class="kt">HTTPHeaders</span> <span class="o">=</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">defaultHTTPHeaders</span> <span class="o">=</span> <span class="kt">SessionManager</span><span class="o">.</span><span class="n">defaultHTTPHeaders</span>
    <span class="n">defaultHTTPHeaders</span><span class="p">[</span><span class="s">"User-Agent"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"You device user agent"</span>
    <span class="n">defaultHTTPHeaders</span><span class="p">[</span><span class="s">"Accept-Encoding"</span><span class="p">]</span> <span class="o">=</span> <span class="n">acceptEncoding</span>
    <span class="c1">// 在 header 中添加 token </span>
    <span class="k">return</span> <span class="n">defaultHTTPHeaders</span>
  <span class="p">}()</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">HTTPClient</span> <span class="p">{</span>
  <span class="kd">@discardableResult</span>
  <span class="kd">func</span> <span class="n">requestObject</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">Codable</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span>
                                 <span class="nv">method</span><span class="p">:</span> <span class="kt">Alamofire</span><span class="o">.</span><span class="kt">HTTPMethod</span> <span class="o">=</span> <span class="o">.</span><span class="k">get</span><span class="p">,</span>
                                 <span class="nv">parameters</span><span class="p">:[</span><span class="kt">String</span><span class="p">:</span><span class="kt">Any</span><span class="p">?]?,</span>
                                 <span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">T</span><span class="p">?,</span> <span class="kt">Error</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="c1">// json -&gt; model</span>
    <span class="k">return</span> <span class="nf">buidRequest</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="nv">method</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">](</span><span class="n">dataSource</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
      <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
        <span class="nf">handler</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="c1">// 通过 `codable` 框架将 raw data 转换 model 对象</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">model</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dataSource</span><span class="o">.</span><span class="n">data</span><span class="p">?</span><span class="o">.</span><span class="nf">mapObject</span><span class="p">(</span><span class="kt">Response</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;.</span><span class="k">self</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="nf">handler</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">parseError</span> <span class="o">=</span> <span class="kt">HTTPClientError</span><span class="p">(</span><span class="nv">code</span><span class="p">:</span><span class="o">.</span><span class="n">decodeError</span><span class="p">,</span><span class="nv">localDescrition</span><span class="p">:</span><span class="s">"parse_error"</span><span class="o">.</span><span class="n">localized</span><span class="p">)</span>
        <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">showDecodingError</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="nf">handler</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">parseError</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MARK: - Private Methods</span>
<span class="kd">private</span> <span class="kd">extension</span> <span class="kt">HTTPClient</span> <span class="p">{</span>
  <span class="c1">/// note: data used by codable</span>
  <span class="kd">typealias</span> <span class="kt">CompletionHandler</span> <span class="o">=</span> <span class="p">((</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">?,</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Any</span><span class="p">?),</span> <span class="kt">Error</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span>
  
  <span class="kd">@discardableResult</span>
  <span class="kd">private</span> <span class="kd">func</span> <span class="nf">buidRequest</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span><span class="kt">String</span><span class="p">,</span>
                           <span class="nv">method</span><span class="p">:</span> <span class="kt">Alamofire</span><span class="o">.</span><span class="kt">HTTPMethod</span><span class="p">,</span>
                           <span class="nv">parameters</span><span class="p">:[</span><span class="kt">String</span><span class="p">:</span><span class="kt">Any</span><span class="p">?]?,</span>
                           <span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="kt">CompletionHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Request</span> <span class="p">{</span>
    
    <span class="c1">// filter nil value</span>
    <span class="k">let</span> <span class="nv">validParas</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">?</span><span class="o">.</span><span class="n">compactMapValues</span> <span class="p">{</span> <span class="nv">$0</span> <span class="p">}</span>
    <span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="n">sessionManager</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">host</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="nv">method</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">validParas</span><span class="p">,</span> <span class="nv">headers</span><span class="p">:</span> <span class="n">defaultHeader</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
      <span class="c1">// 4. 处理 error 和 response code</span>
      <span class="k">self</span><span class="o">.</span><span class="nf">handelResponse</span><span class="p">(</span><span class="nv">response</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>最后我们发起请求的方法大概长这样：</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="kd">func</span> <span class="nf">auth</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">token</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AuthResult</span><span class="p">?</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">path</span> <span class="o">=</span> <span class="s">"wp-json/wc/v3/third/party/access/token"</span>
  <span class="k">let</span> <span class="nv">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s">"from"</span><span class="p">:</span> <span class="n">from</span><span class="p">,</span> <span class="s">"third_access_token"</span><span class="p">:</span> <span class="n">token</span><span class="p">]</span>
  <span class="k">return</span> <span class="kt">HTTPClient</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">requestObject</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">)</span>
<span class="p">}</span>
    
</code></pre></div></div> <h2 id="rxswift-真香系列"> <a href="#rxswift-真香系列" class="anchor-head"></a> RxSwift 真香系列😋 </h2> <p>不会 <code class="language-plaintext highlighter-rouge">RxSwift</code> 建议大家都去学一啦，响应式编程真的很棒棒</p> <h4 id="如何支持-rxswift"> <a href="#如何支持-rxswift" class="anchor-head"></a> 如何支持 RxSwift </h4> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">HTTPClient</span><span class="p">:</span> <span class="kt">ReactiveCompatible</span> <span class="p">{}</span>

<span class="kd">extension</span> <span class="kt">Reactive</span> <span class="k">where</span> <span class="kt">Base</span><span class="p">:</span> <span class="kt">HTTPClient</span> <span class="p">{</span>
  <span class="c1">/// Designated request-making method.</span>
  <span class="c1">///</span>
  <span class="c1">/// - Parameters:</span>
  <span class="c1">///   - path: url path</span>
  <span class="c1">///   - parameters: A dictionary of parameters to apply to a `URLRequest`</span>
  <span class="c1">/// - Returns: Response of singleobject.</span>
  <span class="kd">func</span> <span class="n">requestObject</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">Codable</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span><span class="kt">String</span><span class="p">,</span> <span class="nv">method</span><span class="p">:</span> <span class="kt">HTTPMethod</span> <span class="o">=</span> <span class="o">.</span><span class="k">get</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:[</span><span class="kt">String</span><span class="p">:</span><span class="kt">Any</span><span class="p">?]?)</span> <span class="o">-&gt;</span> <span class="kt">Single</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">?</span><span class="o">&gt;</span> <span class="p">{</span>
    
    <span class="k">return</span> <span class="kt">Single</span><span class="o">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">single</span> <span class="k">in</span>
      <span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="nf">requestObject</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="nv">method</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="nv">model</span><span class="p">:</span> <span class="kt">T</span><span class="p">?,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
          <span class="nf">single</span><span class="p">(</span><span class="o">.</span><span class="nf">error</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nf">single</span><span class="p">(</span><span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="p">}</span>
      <span class="p">})</span>
      
      <span class="k">return</span> <span class="kt">Disposables</span><span class="o">.</span><span class="n">create</span> <span class="p">{</span>
        <span class="n">request</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h4 id="重试和请求合并"> <a href="#重试和请求合并" class="anchor-head"></a> 重试和请求合并 </h4> <p>得益与 RxSwift 重试和请求合并非常简单。</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 请求合并</span>
<span class="kt">Observable</span><span class="o">.</span><span class="nf">zip</span><span class="p">(</span><span class="n">request1</span><span class="p">,</span> <span class="n">request2</span><span class="p">,</span> <span class="n">request3</span><span class="p">)</span>
  <span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nv">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">resp1</span><span class="p">,</span> <span class="n">resp2</span><span class="p">,</span> <span class="n">resp3</span><span class="p">)</span> <span class="k">in</span>
  <span class="p">})</span>
  <span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>

<span class="c1">// 请求重试 </span>
<span class="kt">HTTPClient</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="nf">user</span><span class="p">()</span>
  <span class="o">.</span><span class="nf">asObservable</span><span class="p">()</span>
  <span class="o">.</span><span class="nf">catchErrorJustReturn</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
  <span class="o">.</span><span class="nf">retry</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nv">delay</span><span class="p">:</span> <span class="o">.</span><span class="nf">constant</span><span class="p">(</span><span class="nv">time</span><span class="p">:</span> <span class="mi">3</span><span class="p">))</span>
  <span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>

<span class="c1">// RxSwift+Retry</span>
<span class="kd">enum</span> <span class="kt">DelayOptions</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">immediate</span>
  <span class="k">case</span> <span class="nf">constant</span><span class="p">(</span><span class="nv">time</span><span class="p">:</span> <span class="kt">Double</span><span class="p">)</span>
  <span class="k">case</span> <span class="nf">exponential</span><span class="p">(</span><span class="nv">initial</span><span class="p">:</span> <span class="kt">Double</span><span class="p">,</span> <span class="nv">multiplier</span><span class="p">:</span> <span class="kt">Double</span><span class="p">,</span> <span class="nv">maxDelay</span><span class="p">:</span> <span class="kt">Double</span><span class="p">)</span>
  <span class="k">case</span> <span class="nf">custom</span><span class="p">(</span><span class="nv">closure</span><span class="p">:</span> <span class="p">(</span><span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Double</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">DelayOptions</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">make</span><span class="p">(</span><span class="n">_</span> <span class="nv">attempt</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Double</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">immediate</span><span class="p">:</span> <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">constant</span><span class="p">(</span><span class="k">let</span> <span class="nv">time</span><span class="p">):</span> <span class="k">return</span> <span class="n">time</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">exponential</span><span class="p">(</span><span class="k">let</span> <span class="nv">initial</span><span class="p">,</span> <span class="k">let</span> <span class="nv">multiplier</span><span class="p">,</span> <span class="k">let</span> <span class="nv">maxDelay</span><span class="p">):</span>
      <span class="c1">// if it's first attempt, simply use initial delay, otherwise calculate delay</span>
      <span class="k">let</span> <span class="nv">delay</span> <span class="o">=</span> <span class="n">attempt</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">?</span> <span class="nv">initial</span> <span class="p">:</span> <span class="n">initial</span> <span class="o">*</span> <span class="nf">pow</span><span class="p">(</span><span class="n">multiplier</span><span class="p">,</span> <span class="kt">Double</span><span class="p">(</span><span class="n">attempt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
      <span class="k">return</span> <span class="nf">min</span><span class="p">(</span><span class="n">maxDelay</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">custom</span><span class="p">(</span><span class="k">let</span> <span class="nv">closure</span><span class="p">):</span> <span class="k">return</span> <span class="nf">closure</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">/// 主要是用于网络请求的重试，可以设置重试次数，重试之间的间隔，以及有网络开始重试的逻辑</span>
<span class="c1">/// reference:http://kean.github.io/post/smart-retry</span>
<span class="kd">extension</span> <span class="kt">ObservableType</span> <span class="p">{</span>
  <span class="c1">/// Retries the source observable sequence on error using a provided retry</span>
  <span class="c1">/// strategy.</span>
  <span class="c1">/// - parameter maxAttemptCount: Maximum number of times to repeat the</span>
  <span class="c1">/// sequence. `Int.max` by default.</span>
  <span class="c1">/// - parameter didBecomeReachable: Trigger which is fired when network</span>
  <span class="c1">/// connection becomes reachable.</span>
  <span class="c1">/// - parameter shouldRetry: Always returns `true` by default.</span>
  <span class="kd">func</span> <span class="nf">retry</span><span class="p">(</span><span class="n">_</span> <span class="nv">maxAttemptCount</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
             <span class="nv">delay</span><span class="p">:</span> <span class="kt">DelayOptions</span><span class="p">,</span>
             <span class="nv">didBecomeReachable</span><span class="p">:</span> <span class="kt">Observable</span><span class="o">&lt;</span><span class="kt">Void</span><span class="o">&gt;</span> <span class="o">=</span> <span class="kt">Reachability</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">didBecomeReachable</span><span class="p">,</span>
             <span class="nv">shouldRetry</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Error</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span> <span class="kc">true</span> <span class="p">})</span> <span class="o">-&gt;</span> <span class="kt">Observable</span><span class="o">&lt;</span><span class="kt">Element</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">retryWhen</span> <span class="p">{</span> <span class="p">(</span><span class="nv">errors</span><span class="p">:</span> <span class="kt">Observable</span><span class="o">&lt;</span><span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
      
      <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="nf">enumerated</span><span class="p">()</span><span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">attempt</span><span class="p">,</span><span class="n">error</span> <span class="o">-&gt;</span> <span class="kt">Observable</span><span class="o">&lt;</span><span class="kt">Void</span><span class="o">&gt;</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="nf">shouldRetry</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
          <span class="n">maxAttemptCount</span> <span class="o">&gt;</span> <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="nf">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="kt">Observable</span><span class="o">&lt;</span><span class="kt">Int</span><span class="o">&gt;</span>
          <span class="o">.</span><span class="nf">timer</span><span class="p">(</span><span class="kt">RxTimeInterval</span><span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="kt">Int</span><span class="p">(</span><span class="n">delay</span><span class="o">.</span><span class="nf">make</span><span class="p">(</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))),</span>
                 <span class="nv">scheduler</span><span class="p">:</span> <span class="kt">MainScheduler</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
          <span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">_</span> <span class="nf">in</span> <span class="p">()</span> <span class="p">}</span>
        
        <span class="k">return</span> <span class="kt">Observable</span><span class="o">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">didBecomeReachable</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div> <h2 id="总结"> <a href="#总结" class="anchor-head"></a> 总结 </h2> <p>对我来说要做好一份适用性很强的网络架构不是一件很容易的事情，实际上网络请求的复杂度远远不止于此，这里做的仅仅是把一些通用逻辑统一处理，还有很多本文没有讲到。比如</p> <ol> <li>如何用单一功能原则（Single responsibility principle）优化这里的逻辑</li> <li>当我们遇到服务端返回的不标准的数据结构怎么处理？</li> <li>使用 <code class="language-plaintext highlighter-rouge">Codable</code> 区分返回的是 Array 还是 Object 是要不同处理的</li> <li>当我们有多个 API 地址比如测试环境和正式环境，那么我们如何去管理？</li> </ol> <p>这些都是我们需要去解决的。我当初也踩了无数坑，太难了。 这些问题先留给大家思考吧😆</p> <h2 id="参考"> <a href="#参考" class="anchor-head"></a> 参考 </h2> <p><a href="https://speakerdeck.com/onevcat/wang-lu-zhi-nan-nan-yu-shang-qing-tian-iplayground-2019?slide=143">最后还是大力推荐下喵神在台湾 iPlayground 的演讲</a></p> <p>https://www.youtube.com/watch?v=Xk4HZfW6vK0</p> </div> </article> <!-- unnecessary file, but you can still use for comment section, e.g disqus --> <script src="https://utteranc.es/client.js" repo="alfredcc/blog" issue-term="pathname" label="✨ comment ✨" theme="photon-dark" crossorigin="anonymous" async ></script> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/build-my-blog/" > <div class="nav-arrow">Previous</div> <span class="post-title">2020年如何搭建一个适合自己的 blog</span> </a> </nav> <footer class="footer"> <!-- <a class="footer_item" href="/thanks">ack.</a> --> <a class="footer_item" href="/resume">resume</a> <a class="footer_item" href="/feed.xml">rss</a> <small class="footer_theme-copyright"> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > <span class="footer_item">&copy; 2020</span> </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> <script src="/assets/js/galite.js"></script> <script> var galite = galite || {}; galite.UA = "UA-154766060-1"; </script> </div> </body> </html>
